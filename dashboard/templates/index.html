<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Change Analyzer Dashboard</title>

    <!-- Apache ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Price Change Analyzer Dashboard</h1>
            <div class="header-controls">
                <button id="new-analysis-btn" class="btn btn-primary">+ New Analysis</button>
                <select id="file-selector" class="file-selector">
                    <option value="">Loading files...</option>
                </select>
                <button id="refresh-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </header>

        <!-- New Analysis Modal -->
        <div id="new-analysis-modal" class="modal" style="display: none;">
            <div class="modal-content analysis-modal-content">
                <div class="modal-header">
                    <h3>Run New Price Change Analysis</h3>
                    <button class="modal-close" onclick="document.getElementById('new-analysis-modal').style.display='none'">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="analysis-form" class="analysis-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="symbol-input">Symbol</label>
                                <input type="text" id="symbol-input" placeholder="e.g., SPX_USDT" value="SPX_USDT" required>
                            </div>
                            <div class="form-group">
                                <label for="lookback-input">Lookback</label>
                                <input type="text" id="lookback-input" placeholder="e.g., 3h" value="3h" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="interval-input">Interval</label>
                                <input type="text" id="interval-input" placeholder="e.g., 10s" value="10s" required>
                            </div>
                            <div class="form-group">
                                <label for="top-input">Top N</label>
                                <input type="number" id="top-input" placeholder="5" value="5" min="1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="min-change-input">Min Change %</label>
                                <input type="number" id="min-change-input" placeholder="0.1" value="0.1" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-large">Run Analysis</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('new-analysis-modal').style.display='none'">Cancel</button>
                        </div>
                    </form>
                    <div id="analysis-status" class="analysis-status" style="display: none;">
                        <div class="status-spinner"></div>
                        <div id="status-message">Running analysis...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel: Chart and Stats -->
            <div class="chart-panel">
                <!-- Analysis Info -->
                <div id="analysis-info" class="analysis-info" style="display: none;">
                    <div class="info-item">
                        <span class="info-icon">üìä</span>
                        <span id="info-symbol" class="info-text">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">‚è±Ô∏è</span>
                        <span id="info-interval" class="info-text">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üîç</span>
                        <span id="info-lookback" class="info-text">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üìà</span>
                        <span id="info-threshold" class="info-text">-</span>
                    </div>
                </div>

                <!-- Stats Summary -->
                <div id="stats-summary" class="stats-summary">
                    <div class="stat-item">
                        <span class="stat-label">Rank:</span>
                        <span id="stat-rank" class="stat-value">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Change:</span>
                        <span id="stat-change" class="stat-value">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Time:</span>
                        <span id="stat-time" class="stat-value">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Price:</span>
                        <span id="stat-price" class="stat-value">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Events:</span>
                        <span id="stat-events" class="stat-value">-</span>
                    </div>
                </div>

                <!-- Interval Selector (if multiple intervals in file) -->
                <div id="interval-selector-container" class="interval-selector-container" style="display: none;">
                    <label for="interval-selector">Select Interval:</label>
                    <select id="interval-selector" class="interval-selector">
                        <option value="">Select an interval...</option>
                    </select>
                </div>

                <!-- Chart Container -->
                <div class="chart-wrapper">
                    <button id="fullscreen-btn" class="fullscreen-btn" title="Toggle Fullscreen">‚õ∂</button>
                    <div id="chart-container" class="chart-container">
                        <div id="loading" class="loading">
                            <div class="spinner"></div>
                            <p>Loading chart data...</p>
                        </div>
                    </div>
                </div>

                <!-- Chart Legend -->
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-marker" style="background: #00c2ff;"></span>
                        <span>Price</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-marker" style="background: #00ffa3;"></span>
                        <span>Bid Events</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-marker" style="background: #ff3b69;"></span>
                        <span>Ask Events</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-marker" style="background: #ffd60a;"></span>
                        <span>Market Trades</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Whale Events -->
            <div class="events-panel">
                <div class="events-header">
                    <h2>Whale Events</h2>
                    <div class="events-filters">
                        <input type="text" id="event-search" placeholder="Search events..." class="search-input">
                        <select id="event-type-filter" class="filter-select">
                            <option value="">All Types</option>
                            <option value="new_bid">New Bid</option>
                            <option value="new_ask">New Ask</option>
                            <option value="increase">Volume Increase</option>
                            <option value="decrease">Volume Decrease</option>
                            <option value="market_buy">Market Buy</option>
                            <option value="market_sell">Market Sell</option>
                            <option value="entered_top">Entered Top</option>
                            <option value="left_top">Left Top</option>
                        </select>
                        <div class="usd-filter-container">
                            <label for="min-usd-filter">Min USD:</label>
                            <input type="number" id="min-usd-filter" placeholder="0" min="0" step="1000" class="usd-filter-input">
                        </div>
                    </div>
                </div>

                <!-- Event Statistics -->
                <div id="event-stats" class="event-stats">
                    <div class="event-stat">
                        <span class="event-stat-label">Total Events:</span>
                        <span id="event-stat-total" class="event-stat-value">0</span>
                    </div>
                    <div class="event-stat">
                        <span class="event-stat-label">Total Volume:</span>
                        <span id="event-stat-volume" class="event-stat-value">$0</span>
                    </div>
                    <div class="event-stat">
                        <span class="event-stat-label">Biggest Whale:</span>
                        <span id="event-stat-biggest" class="event-stat-value">$0</span>
                    </div>
                    <div class="event-stat">
                        <span class="event-stat-label">Biggest (During):</span>
                        <span id="event-stat-biggest-during" class="event-stat-value">$0</span>
                    </div>
                </div>

                <!-- Analytical Insights -->
                <div id="insights-panel" class="insights-panel" style="display: none;">
                    <div class="insights-header">üìä Analysis</div>
                    <div id="insights-content" class="insights-content"></div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Price Change Analyzer Dashboard | Powered by <a href="https://www.tradingview.com" target="_blank">TradingView Lightweight Charts</a></p>
        </footer>
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="error-toast" style="display: none;">
        <span id="error-message"></span>
        <button onclick="this.parentElement.style.display='none'">&times;</button>
    </div>

    <!-- Event Details Modal -->
    <div id="event-details-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Whale Events at Time</h3>
                <button class="modal-close" onclick="document.getElementById('event-details-modal').style.display='none'">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
</body>
</html>
